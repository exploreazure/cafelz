#
# This workflow deploys a management group hierarchy in Azure.
#

name: Infra-MG-Deploy

on:
  push:
    branches: [ none ]
  workflow_dispatch:

jobs:
  deploy-mg:
    runs-on: windows-latest
    steps:
      - name: Check out repository under $GITHUB_WORKSPACE, so job can access it
        uses: actions/checkout@v2

      - name: Log on to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
          
      - name: Deploy MG
        uses: azure/powershell@v1
        with:
          inlineScript: |      
            #
            # Deploy MG resources from template
            #
            Write-Host "Deploying landing zone resources"
            $mgLocation = 'uksouth'
            $deploymentName = Get-Date -Format yyyyMMddHHmmss
            New-AzTenantDeployment -Name $deploymentName -Location $mgLocation -Verbose -TemplateFile ./src/infra/mg/.mg.bicep
          azPSVersion: latest 
